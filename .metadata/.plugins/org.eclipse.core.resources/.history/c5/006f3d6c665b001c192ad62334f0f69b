package application.view;

import java.time.ZoneId;

import java.util.Collections;
import java.util.Date;
import java.util.List;
import java.util.stream.Collectors;

import org.apache.commons.lang3.RandomStringUtils;

import com.password4j.BCryptFunction;
import com.password4j.Hash;
import com.password4j.Password;
import com.password4j.types.BCrypt;

import application.Main;
import application.controller.ScheduleController;
import application.controller.UsersController;
import application.model.Drivers;
import application.model.Schedule;
import application.model.Trailers;
import application.model.Trucks;
import application.model.Users;
import application.model.Users.Role;
import application.view.intermediate.Converter;
import application.view.intermediate.ScheduleIntermediate;
import javafx.collections.ListChangeListener;
import javafx.collections.ListChangeListener.Change;
import javafx.fxml.FXML;

import javafx.scene.control.Button;
import javafx.scene.control.ChoiceBox;
import javafx.scene.control.ComboBox;
import javafx.scene.control.DatePicker;
import javafx.scene.control.PasswordField;
import javafx.scene.control.TableCell;
import javafx.scene.control.TableColumn;
import javafx.scene.control.TableView;
import javafx.scene.control.TableView.TableViewSelectionModel;
import javafx.scene.control.TextField;
import javafx.scene.control.ToggleButton;
import javafx.scene.control.cell.PropertyValueFactory;
import javafx.scene.layout.AnchorPane;
import javafx.scene.layout.HBox;

import java.text.SimpleDateFormat;

public class ArrivalsDeparturesViewController {

	@FXML
	private TextField drivingLicenseTextField;
	@FXML
	private TextField truckLicenseNumberTextField;
	@FXML
	private TextField trailerLicenseNumberTextField;
	@FXML
	private TextField scheduledDateTextField;
	@FXML
	private TextField typeTextField;
	@FXML
	private TextField nameSurnameTextField;
	@FXML
	private TextField brandTextField;
	@FXML
	private TextField trailerTypeTextField;
	@FXML
	private AnchorPane infoPanel;
	@FXML
	private Button letInButton;
	@FXML
	private Button letOutButton;

	private Schedule selectedSchedule;

	private Main main;

	public void onSearchButtonClick() {

		selectedSchedule = null;

		String driverLicenseNumber = drivingLicenseTextField.getText().trim();
		Drivers driver = main.getDriversController().getByDriverLicense(driverLicenseNumber);

		String truckLicenseNumber = truckLicenseNumberTextField.getText().trim();
		Trucks truck = main.getTrucksController().getByTruckNumber(truckLicenseNumber);

		String trailerLicenseNumber = trailerLicenseNumberTextField.getText().trim();
		Trailers trailer = main.getTrailersController().getByTrailerNumber(trailerLicenseNumber);

		if (driver != null && truck != null && trailer != null) {

			List<Schedule> schedules = main.getScheduleController().getSchedulesByData(driver, trailer, truck);

			Date currentDate = new Date(System.currentTimeMillis());

			for (Schedule schedule : schedules) {

				if (schedule.getDeparture_date() == null) {
					if (selectedSchedule == null) {
						selectedSchedule = schedule;
					} else if (selectedSchedule.getScheduled_date().compareTo(schedule.getScheduled_date()) > 0) {
						selectedSchedule = schedule;
					}
				}

			}
		}

		updateInfoPanel();

	}

	private void updateInfoPanel() {
		
		if (selectedSchedule != null) {
			infoPanel.setVisible(true);
			letInButton.setVisible(selectedSchedule.getArrival_date() == null);
			letOutButton.setVisible(selectedSchedule.getArrival_date() != null && selectedSchedule.getDeparture_date() == null);
			scheduledDateTextField.setText(selectedSchedule.getScheduled_date().toString());
			nameSurnameTextField.setText(selectedSchedule.getDriver().getName() + ' ' + selectedSchedule.getDriver().getSurname());
			typeTextField.setText(selectedSchedule.getType());
			brandTextField.setText(selectedSchedule.getTruck().getBrand());
			trailerTypeTextField.setText(selectedSchedule.getTrailer().getTrailer_type());
			
		}
		else {
			infoPanel.setVisible(false);
		}

	}

	public void onLetInButtonClick() {
		
		

	}

	public void onLetOutButtonClick() {

	}

	public void setUp() {

		infoPanel.setVisible(false);

	}

	public void setmainapp(Main main) {

		this.main = main;

	}

}
